openapi: 3.0.0
info:
  version: '1'
  title: 'MyAce API Documentation'
  x-logo:
    url: 'https://myace.ai/logo.svg'
    # backgroundColor: '#FFFFFF'
    altText: 'MyAce logo'
servers:
  - url: 'https://api.myace.ai'
paths:
  /login/:
    post:
      summary: Login
      description: This route establishes a session and returns a user. If the user does not exist, the user is created.
      tags:
        - User
      requestBody:
        description: Google OAuth token
        required: true
        content:
          'application/json':
              schema:
                type: object
                required:
                  - token
                properties:
                  token:
                    type: string
                    example: "{GOOGLE TOKEN}"
      security: [] # no authentication
      responses:
        '200':
          description: User fetched.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Me'
        '201':
          description: User created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Me'
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /logout/:
    post:
      summary: Logout
      description: This route ends a user session. All sensitive routes will return error code 401 until the user's session is reestablished.
      tags:
        - User
      responses:
        '200':
          description: 'Logout successful.'
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/me/:
    put:
      summary: Update current user
      description: This route edits the profile of the user who is currently logged in.
      tags:
        - User
      requestBody:
        description: All fields are optional
        required: false
        content:
          'application/json':
              schema:
                type: object
                properties:
                  username:
                    type: string
                    example: "tennislover9"
                  display_name:
                    type: string
                    example: "John Smith"
      responses:
        '200':
          description: User updated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Me'
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /uploads:
    get:
      summary: Get all uploads
      description: Without any query parameters, get a list of the current user's uploads.
      operationId: "getUploads" # keeping operationId here so i don't forget about i
      tags:
        - Uploads
      parameters:
        - name: user
          in: query
          description: Filter response to uploads by a given user ID.
          required: false
          schema:
            type: integer
            format: int64
            minimum: 1
        - name: bucket
          in: query
          description: Filter response to uploads in a given bucket ID.
          required: false
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        '200':
          description: 'Retrieved uploads.'
          content:
            application/json:
              schema:
                type: array
                items:
                    type: object
                    $ref: "#/components/schemas/Upload"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /uploads/{upload_id}/:
    get:
      summary: Get upload by ID
      description: This route returns a specific upload, containing the URL to Apple's HTTP Live Streaming (HLS) playlist and setting cookies which enable temporary URL access. If stream_ready is false, the url and thumbnail fields will be omitted from the response.
      tags:
        - Uploads
      parameters:
        - name: upload_id
          in: path
          description: Numeric ID of the upload to get
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        '200':
          description: 'Retrieved upload.'
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Upload"
                  - type: object
                    required:
                      - url
                    properties:
                      url:
                        type: string
                        example: "https://www.something.m3u8"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: Edit upload
      description: This route edits the attributes of an upload.
      tags:
        - Uploads
      parameters:
        - name: upload_id
          in: path
          description: Numeric ID of the upload to edit
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      requestBody:
        description: All fields are optional
        required: false
        content:
          'application/json':
              schema:
                type: object
                properties:
                  display_title:
                    type: string
                    example: "Winning volley against Nadal"
                  bucket_id:
                    type: integer
                    format: int64
                    minimum: 1
                  visibility:
                    type: object
                    $ref: '#/components/schemas/VisibilitySettingReq'
      responses:
        '200':
          description: Updated upload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Upload'
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Delete upload
      description: This route permanently deletes a specified upload.
      tags:
        - Uploads
      parameters:
        - name: upload_id
          in: path
          description: Numeric ID of the upload to delete
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        '204':
          description: Deleted upload.
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /uploads/:
    post:
      summary: Create upload URL
      # TODO: what happens if an upload fails?
      description: This route returns a presigned URL, which must be used to upload a video file directly to AWS using a POST request. The POST request to the AWS url must contain the specified fields. Furthermore, all field names containing underscores within fields, such as x_amz_date, must be hyphenated (ex. x-amz-date) when uploading to AWS. After a successful upload, the client should request to convert the media to a streamable format.
      tags:
        - Uploads
      requestBody:
        required: true
        content:
          'application/json':
              schema:
                type: object
                required:
                  - filename
                  - display_title
                  - bucket_id
                  - visibility
                properties:
                    filename:
                        type: string
                        example: "volley.mp4"
                    display_title:
                        type: string
                        example: "Winning volley against Nadal"
                    bucket_id:
                        type: integer
                        format: int64
                        minimum: 1
                    visibility:
                        type: object
                        $ref: '#/components/schemas/VisibilitySettingReq'
      responses:
        '201':
          description: Upload URL created.
          content:
            application/json:
              schema:
                type: object
                required:
                  - id
                  - url
                  - fields
                properties:
                  id:
                    type: integer
                    format: int64
                    minimum: 1
                    description: The newly created upload ID
                  url:
                    type: string
                    example: "https://s3.us-east-2.amazonaws.com/example"
                  fields:
                    type: object
                    required:
                      - key
                      - x_amz_algorithm
                      - x_amz_credential
                      - x_amz_date
                      - policy
                      - x_amz_signature
                    properties:
                      key:
                        type: string
                        example: "volley.mp4"
                      x_amz_algorithm:
                        type: string
                      x_amz_credential:
                        type: string
                      x_amz_date:
                        type: string
                      policy:
                        type: string
                      x_amz_signature:
                        type: string
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /uploads/{upload_id}/convert/:
    post:
      summary: Convert upload to stream-ready
      description: This route begins converting an upload into a streamable format.
      tags:
        - Uploads
      parameters:
        - name: upload_id
          in: path
          description: Numeric ID of the upload to convert
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        '200':
          description: 'Began conversion'
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /uploads/{upload_id}/download/:
    post:
      summary: Get download URL
      description: This route returns a presigned URL which can be used to download the originally uploaded file directly from AWS. If a user can see a post, they are permitted to download it.
      tags:
        - Uploads
      parameters:
        - name: upload_id
          in: path
          description: Numeric ID of the upload to download
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        '200':
          description: 'Retrieved URL'
          content:
            application/json:
              schema:
                type: object
                required:
                  - url
                properties:
                  url:
                    type: string
                    example: "https://www.something.com/.../filename.mp4"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /comments:
    get:
      summary: Get all comments
      description: Without any query parameters, get a list of comments authored by the current user.
      tags:
        - Comments
      parameters:
        - name: upload
          in: query
          description: Return all comments under a specific upload ID.
          required: false
          schema:
            type: integer
            format: int64
            minimum: 1
        # - name: courtship
        #   in: query
        #   description: "Filter response to comments created by a specific type of user. The user may only view coach comments on their own uploads. TODO: this needs to be fixed"
        #   required: false
        #   schema:
        #     type: string
        #     enum:
        #       - friend
        #       - coach
        #       - student
      responses:
        '200':
          description: 'Retrieved comments'
          content:
            application/json:
              schema:
                type: array
                items:
                    type: object
                    $ref: "#/components/schemas/Comment"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /comments/:
    post:
      summary: Create comment
      description: This route posts a comment under a specified upload.
      tags:
        - Comments
      requestBody:
        required: true
        content:
          'application/json':
              schema:
                type: object
                $ref: "#/components/schemas/CommentRequest"
      responses:
        '201':
          description: Comment created
          content:
            application/json:
              schema:
                type: object
                $ref: "#/components/schemas/Comment"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /comments/{comment_id}/:
    delete:
      summary: Delete comment
      description: This route permanently deletes a specified comment. Upload owners may delete all comments under their uploads, and comment authors may delete their comments.
      tags:
        - Comments
      parameters:
        - name: comment_id
          in: path
          description: Numeric ID of the comment to delete
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        '204':
          description: Deleted comment.
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /buckets/:
    post:
      summary: Create bucket
      description: This route creates a bucket specific to the user. A user cannot have multiple buckets of the same name. A user must create at least one bucket before uploading a video.
      tags:
        - Buckets
      requestBody:
        required: true
        content:
          'application/json':
              schema:
                type: object
                $ref: "#/components/schemas/BucketRequest"
      responses:
        '201':
          description: Bucket created
          content:
            application/json:
              schema:
                type: object
                $ref: "#/components/schemas/Bucket"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /buckets:
    get:
      summary: Get all buckets
      description: Without any query parameters, get a list of buckets owned by the current user.
      tags:
        - Buckets
      parameters:
        - name: user
          in: query
          description: Filter response to buckets owned by a given user ID.
          required: false
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        '200':
          description: 'Retrieved buckets'
          content:
            application/json:
              schema:
                type: array
                items:
                    type: object
                    $ref: "#/components/schemas/Bucket"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /buckets/{bucket_id}/:
    put:
      summary: Edit bucket
      description: This route only updates the properties of a bucket. To transfer an upload to another bucket, see edit upload.
      tags:
        - Buckets
      parameters:
        - name: bucket_id
          in: path
          description: Numeric ID of the bucket to edit
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      requestBody:
        description: All fields are optional
        required: false
        content:
          'application/json':
              schema:
                type: object
                properties:
                  name:
                    type: string
                    example: "New bucket name"
      responses:
        '200':
          description: Updated bucket
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Bucket'
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Delete bucket
      description: This route permanently deletes a specified bucket and all its associated uploads.
      tags:
        - Buckets
      parameters:
        - name: bucket_id
          in: path
          description: Numeric ID of the bucket to delete
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        '204':
          description: Deleted bucket and uploads
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/search:
    get:
      summary: Search for users
      description: This route returns a list of users given a search query. The current user is excluded from the response.
      tags:
        - Courtships
        - User
      parameters:
        - name: q
          in: query
          description: The search query.
          required: true
          schema:
            type: string
            example: tennislover9
      responses:
        '200':
          description: 'Retrieved search results.'
          content:
            application/json:
              schema:
                type: object
                required:
                  - users
                properties:
                  users:
                    type: array
                    items:
                        type: object
                        $ref: "#/components/schemas/UserOverview"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /courtships/requests/:
    post:
      summary: Create courtship request
      description: This route begins the courting process, ha ha 😐. Request that another user become your friend, student, xor coach. The current user cannot have an existing relationship with the specified user. For example, requesting to friend someone who has already requested to friend you will yield an error. As another example, requesting to coach your friend will yield an error until you unfriend them.
      tags:
        - Courtships
      requestBody:
        required: true
        content:
          'application/json':
              schema:
                type: object
                required:
                  - user_id
                  - type
                properties:
                  user_id:
                    type: integer
                    format: int64
                    minimum: 1
                    example: 2
                  type:
                    type: string
                    enum:
                      - friend
                      - student
                      - coach
      responses:
        '201':
          description: Courtship request created
          # TODO: respond w newly created courtship req
          # content:
          #   application/json:
          #     schema:
          #       type: object
          #       $ref: '#/components/schemas/CourtshipReqResponse'
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /courtships/requests:
    get:
      summary: Get courtship requests
      description:
          Get a list of all incoming and outgoing courtship requests involving the current user.

            <table>
                <tr>
                    <th>Dir</th>
                    <th>Request Type</th>
                    <th>Meaning</th>
                </tr>
                <tr>
                    <td>out</td>
                    <td>friend</td>
                    <td>You request to add another user as a friend</td>
                </tr>
                <tr>
                    <td>out</td>
                    <td>coach</td>
                    <td>You request that another user becomes your coach</td>
                </tr>
                <tr>
                    <td>out</td>
                    <td>student</td>
                    <td>You request that another user becomes your student</td>
                </tr>
                <tr>
                    <td>in</td>
                    <td>friend</td>
                    <td>Another user requests to add you as a friend</td>
                </tr>
                <tr>
                    <td>in</td>
                    <td>coach</td>
                    <td>Another user requests that you coach them</td>
                </tr>
                <tr>
                    <td>in</td>
                    <td>student</td>
                    <td>Another user requests to coach you</td>
                </tr>
            </table>
      tags:
        - Courtships
      parameters:
        - name: type
          in: query
          description: Filter response by the type of request.
          required: false
          schema:
            type: string
            enum:
              - friend
              - student
              - coach
        - name: dir
          in: query
          description: Filter response by the direction of the request.
          required: false
          schema:
            type: string
            enum:
              - in
              - out
        - name: users
          in: query
          description: Filter response to requests to/from users specified by a comma separated list of user IDs.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: 'Retrieved courtship requests'
          content:
            application/json:
              schema:
                type: object
                required:
                  - requests
                properties:
                  requests:
                    type: array
                    items:
                        type: object
                        $ref: '#/components/schemas/CourtshipReqResponse'
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /courtships/requests/{other_user_id}/:
    put:
      summary: Update incoming courtship request
      description: This route responds to an incoming courtship request.
      tags:
        - Courtships
      parameters:
        - name: other_user_id
          in: path
          description: Numeric ID of the other user to whom the current user wishes to respond
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      requestBody:
        description: The user's response to the courtship request
        required: true
        content:
          'application/json':
              schema:
                type: object
                required:
                  - status
                properties:
                  status:
                    type: string
                    enum:
                      - accept
                      - decline
      responses:
        '204':
          description: Responded to request
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Delete outgoing courtship request
      tags:
        - Courtships
      parameters:
        - name: other_user_id
          in: path
          description: Numeric ID of the other user to whom the request was sent
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        '204':
          description: Deleted request
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /courtships:
    get:
      summary: Get courtships
      description:
          Get a list of established courtships involving the current user.

            <table>
            <tr>
                <th>Courtship Type</th>
                <th>Meaning</th>
            </tr>
            <tr>
                <td>friend</td>
                <td>This user is your friend</td>
            </tr>
            <tr>
                <td>coach</td>
                <td>This user is your coach</td>
            </tr>
            <tr>
                <td>friend</td>
                <td>This user is your student</td>
            </tr>
            </table>
      tags:
        - Courtships
      parameters:
        - name: type
          in: query
          description: Filter response by the type of courtship. For example, "student" will only return the current user's students.
          required: false
          schema:
            type: string
            enum:
              - friend
              - student
              - coach
        - name: users
          in: query
          description: Filter response to courtships to/from users specified by a comma separated list of user IDs.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: 'Retrieved courtships'
          content:
            application/json:
              schema:
                type: object
                required:
                  - courtships
                properties:
                  courtships:
                    type: array
                    items:
                        type: object
                        $ref: "#/components/schemas/Courtship"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /courtships/{other_user_id}/:
    delete:
      summary: Remove courtship
      tags:
        - Courtships
      parameters:
        - name: other_user_id
          in: path
          description: Numeric ID of the other user involved in the courtship
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
      responses:
        '204':
          description: Deleted request
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'


components:
  schemas:

    Upload:
        type: object
        required:
            - id
            - created
            - display_title
            - stream_ready
            - bucket
            - visibility
        properties:
            id:
                type: integer
                format: int64
                minimum: 1
            created:
                type: string
                format: date-time
            display_title:
                type: string
                example: "Winning volley against Nadal"
            stream_ready:
                type: boolean
                example: true
            bucket:
                type: object
                $ref: "#/components/schemas/Bucket"
            thumbnail:
                type: string
                description: "Will be omitted if stream_ready is false"
                example: "https://www.something.jpg"
            visibility:
                type: object
                $ref: "#/components/schemas/VisibilitySetting"

    VisibilitySettingReq:
      type: object
      required:
        - default
        - also_shared_with
      properties:
        default:
          type: string
          description: "The default visibility mode. For example, 'coaches' automatically shares an upload with all of the user's coaches."
          enum:
            - private
            - coaches-only
            - friends-only
            - friends-and-coaches
            - public
        also_shared_with:
          type: array
          description: "A list of user IDs who are exceptions to the default visibility mode. Any included user will be able to view an upload with this visibility, regardless of the default."
          items:
            type: integer
            format: int64
            minimum: 1

    VisibilitySetting:
      type: object
      required:
        - default
        - also_shared_with
      properties:
        default:
          type: string
          description: "The default visibility mode. For example, 'coaches' automatically shares an upload with all of the user's coaches."
          enum:
            - private
            - coaches-only
            - friends-only
            - friends-and-coaches
            - public
        also_shared_with:
          type: array
          description: "Exceptions to the default visibility mode. Any included user will be able to view an upload with this visibility, regardless of the default."
          items:
            type: object
            $ref: "#/components/schemas/UserOverview"

    Me:
      description: "The currently logged in user. Exposes sensitive profile information."
      allOf:
        - $ref: "#/components/schemas/UserOverview"
        - type: object
          required:
            - email
          properties:
            email:
              type: string
              example: johnsmith@gmail.com

    UserOverview:
      type: object
      description: "A synopsis of a user's profile. What you might find as an identifier to a user's comment or upload."
      required:
        - id
        - username
        - display_name
      properties:
        id:
          type: integer
          format: int64
          minimum: 1
          example: 1
        username:
          type: string
          example: tennislover9
        display_name:
          type: string
          example: John Smith

    Courtship:
      type: object
      required:
        - type
        - user
      properties:
        type:
          type: string
          enum:
            - friend
            - student
            - coach
        user:
          type: object
          $ref: "#/components/schemas/UserOverview"

    CourtshipReqResponse:
      description: "The schema of a pending courtship request."

      allOf:
        - $ref: "#/components/schemas/Courtship"
        - type: object
          required:
            - dir
          properties:
            dir:
              type: string
              enum:
              - in
              - out

    Bucket:
      allOf:
        - type: object
          required:
          - id
          - size
          - last_modified
          properties:
            id:
              type: integer
              format: int64
              minimum: 1
            size:
              type: integer
              format: int32
              minimum: 0
              example: 5
              description: "The quantity of uploads in this bucket."
            last_modified:
              type: string
              format: date-time
              description: "If the bucket is empty, the bucket's creation datetime."
        - $ref: '#/components/schemas/BucketRequest'

    BucketRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          example: "Forehand Groundstrokes 🎾"

    Comment:
      allOf:
        - type: object
          required:
              - id
              - created
              - author
          properties:
            id:
              type: integer
              format: int64
              minimum: 1
            created:
              type: string
              format: date-time
            author:
              type: object
              $ref: "#/components/schemas/UserOverview"
        - $ref: "#/components/schemas/CommentRequest"

    CommentRequest:
      description: "Schema required to create a comment."
      type: object
      required:
        - upload_id
        - text
      properties:
        text:
          type: string
          example: "Tennis goals!!! LOML 😍"
        upload_id:
          type: integer
          format: int64
          minimum: 1

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string

  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session
security:
  - cookieAuth: []
